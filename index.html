<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Image Regions</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            text-align: center;
        }

        #upload-container {
            margin: 20px;
        }

        #region-table {
            margin-top: 20px;
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            text-align: left;
        }

        #region-table th, #region-table td {
            padding: 8px;
            border: 1px solid #ccc;
        }

        #region-table th {
            background-color: #eee;
        }

        canvas {
            border: 2px solid #000;
            margin: 20px 0;
        }

        #color-input {
            margin-top: 20px;
        }

        #render-btn {
            margin-top: 20px;
        }

        #hover-box {
            position: absolute;
            border: 2px solid #ff0000;
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>

    <div id="upload-container">
        <input type="file" id="image-input" accept="image/*">
        <button id="render-btn">Render Image</button>
        <input type="color" id="color-input" value="#ff0000">
    </div>

    <canvas id="canvas"></canvas>

    <table id="region-table" style="display: none;">
        <thead>
            <tr>
                <th>Region Name</th>
                <th>Color</th>
                <th>Position (X, Y)</th>
                <th>Size (Width, Height)</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div id="hover-box"></div>

    <script>
        const renderBtn = document.getElementById('render-btn');
        const imageInput = document.getElementById('image-input');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const regionTable = document.getElementById('region-table').getElementsByTagName('tbody')[0];
        const colorInput = document.getElementById('color-input');
        const hoverBox = document.getElementById('hover-box');

        let img = new Image();
        let regions = [];
        let selectedRegion = null;
        let selectedColor = colorInput.value;
        let pixelData = null;

        const colorThreshold = 50;  // Threshold for detecting color changes (higher = more sensitive)

        // Variable to track if the image is uploaded but not yet rendered
        let imageReady = false;

        // Handle image input change (image upload)
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.onload = function() {
                        // Set imageReady to true after the image is loaded
                        imageReady = true;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        renderBtn.addEventListener('click', () => {
            if (!imageReady) {
                alert('Please upload an image first!');
                return;
            }

            // Clear the table and show it
            regionTable.innerHTML = ''; // Clear the table
            regionTable.style.display = 'block'; // Show the table

            // Clear the canvas before drawing the image
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw the uploaded image on the canvas
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            // Get image pixel data
            pixelData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            // Detect color changes and create regions
            detectColorChanges();

            // Draw borders for detected regions
            regions.forEach(region => {
                ctx.strokeStyle = region.color;
                ctx.lineWidth = 2;
                ctx.strokeRect(region.x, region.y, region.width, region.height);
            });

            // Make regions clickable
            canvas.addEventListener('click', (event) => {
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                regions.forEach((region, index) => {
                    if (
                        x >= region.x && x <= region.x + region.width &&
                        y >= region.y && y <= region.y + region.height
                    ) {
                        // Set the selected region
                        selectedRegion = region;
                        selectedRegion.index = index;

                        // Highlight the selected region
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        regions.forEach(r => {
                            if (r !== selectedRegion) {
                                ctx.strokeStyle = r.color;
                                ctx.lineWidth = 2;
                                ctx.strokeRect(r.x, r.y, r.width, r.height);
                            }
                        });
                        ctx.strokeStyle = 'blue';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(selectedRegion.x, selectedRegion.y, selectedRegion.width, selectedRegion.height);

                        // Prompt for region name
                        const regionName = prompt('Enter a name for this region:');
                        if (regionName) {
                            // Update the region name
                            selectedRegion.name = regionName;

                            // Add the name and color to the table
                            const row = regionTable.insertRow();
                            row.insertCell(0).textContent = selectedRegion.name;
                            row.insertCell(1).textContent = selectedColor;
                            row.insertCell(2).textContent = `${selectedRegion.x}, ${selectedRegion.y}`;
                            row.insertCell(3).textContent = `${selectedRegion.width}, ${selectedRegion.height}`;
                        }

                        // Ensure the table is visible after entering the name
                        regionTable.style.display = 'block';
                    }
                });
            });

            // Hover effect
            canvas.addEventListener('mousemove', (event) => {
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                let hoverRegion = null;
                regions.forEach((region) => {
                    if (
                        x >= region.x && x <= region.x + region.width &&
                        y >= region.y && y <= region.y + region.height
                    ) {
                        hoverRegion = region;
                    }
                });

                if (hoverRegion) {
                    hoverBox.style.display = 'block';
                    hoverBox.style.left = `${hoverRegion.x}px`;
                    hoverBox.style.top = `${hoverRegion.y}px`;
                    hoverBox.style.width = `${hoverRegion.width}px`;
                    hoverBox.style.height = `${hoverRegion.height}px`;
                } else {
                    hoverBox.style.display = 'none';
                }
            });
        });

        // Handle color input change
        colorInput.addEventListener('input', (event) => {
            selectedColor = event.target.value;
            if (selectedRegion) {
                selectedRegion.color = selectedColor;
                // Re-draw the image with the updated color for the selected region
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                regions.forEach(r => {
                    ctx.strokeStyle = r.color;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(r.x, r.y, r.width, r.height);
                });
            }
        });

        function detectColorChanges() {
            const width = canvas.width;
            const height = canvas.height;
            const threshold = colorThreshold;
            const regions = [];

            // Loop through all pixels and compare color differences
            for (let y = 0; y < height - 1; y++) {
                for (let x = 0; x < width - 1; x++) {
                    const pixelIndex = (y * width + x) * 4;

                    const r = pixelData.data[pixelIndex];
                    const g = pixelData.data[pixelIndex + 1];
                    const b = pixelData.data[pixelIndex + 2];

                    const rightPixelIndex = (y * width + x + 1) * 4;
                    const bottomPixelIndex = ((y + 1) * width + x) * 4;

                    const rRight = pixelData.data[rightPixelIndex];
                    const gRight = pixelData.data[rightPixelIndex + 1];
                    const bRight = pixelData.data[rightPixelIndex + 2];

                    const rBottom = pixelData.data[bottomPixelIndex];
                    const gBottom = pixelData.data[bottomPixelIndex + 1];
                    const bBottom = pixelData.data[bottomPixelIndex + 2];

                    // Calculate color differences
                    const colorDiffRight = Math.abs(r - rRight) + Math.abs(g - gRight) + Math.abs(b - bRight);
                    const colorDiffBottom = Math.abs(r - rBottom) + Math.abs(g - gBottom) + Math.abs(b - bBottom);

                    if (colorDiffRight > threshold || colorDiffBottom > threshold) {
                        regions.push({
                            x: x,
                            y: y,
                            width: 10, // Arbitrary region size for illustration
                            height: 10, // Arbitrary region size for illustration
                            color: `rgb(${r},${g},${b})`
                        });
                    }
                }
            }

            // Save the detected regions
            regions.push(...regions);
        }
    </script>

</body>
</html>
