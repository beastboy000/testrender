<script>
    const canvas = document.getElementById('image-canvas');
    const ctx = canvas.getContext('2d');
    const fileInput = document.getElementById('file-input');
    const colorInput = document.getElementById('color-input');
    const regionTable = document.getElementById('region-table').getElementsByTagName('tbody')[0];
    const hoverBox = document.getElementById('hover-box');
    let img = new Image();
    let regions = [];
    let selectedColor = colorInput.value;
    let selectedRegion = null;
    let isDragging = false;
    let dragOffsetX, dragOffsetY;

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    detectEdges();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    function detectEdges() {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const width = canvas.width;
        const height = canvas.height;
        const threshold = 40;
        regions = [];

        const kernelX = [
            [-1, 0, 1],
            [-2, 0, 2],
            [-1, 0, 1]
        ];
        const kernelY = [
            [-1, -2, -1],
            [0, 0, 0],
            [1, 2, 1]
        ];

        for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                let gx = 0, gy = 0;
                for (let ky = -1; ky <= 1; ky++) {
                    for (let kx = -1; kx <= 1; kx++) {
                        const pixel = getPixel(x + kx, y + ky, data, width);
                        gx += pixel.r * kernelX[ky + 1][kx + 1];
                        gy += pixel.r * kernelY[ky + 1][kx + 1];
                    }
                }
                const magnitude = Math.sqrt(gx * gx + gy * gy);
                if (magnitude > threshold) {
                    const region = { x, y, width: 10, height: 10, color: selectedColor };
                    regions.push(region);
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, region.width, region.height);
                }
            }
        }
    }

    function getPixel(x, y, data, width) {
        const i = (y * width + x) * 4;
        return {
            r: data[i],
            g: data[i + 1],
            b: data[i + 2],
            a: data[i + 3]
        };
    }

    // Handle the mousemove event to show hover box
    canvas.addEventListener('mousemove', (event) => {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        let hoverRegion = null;

        regions.forEach((region) => {
            if (
                x >= region.x && x <= region.x + region.width &&
                y >= region.y && y <= region.y + region.height
            ) {
                hoverRegion = region;
            }
        });

        if (hoverRegion) {
            hoverBox.style.display = 'block';
            hoverBox.style.left = `${hoverRegion.x + rect.left}px`;  // Position relative to the canvas container
            hoverBox.style.top = `${hoverRegion.y + rect.top}px`;
            hoverBox.style.width = `${hoverRegion.width}px`;
            hoverBox.style.height = `${hoverRegion.height}px`;
        } else {
            hoverBox.style.display = 'none';
        }
    });

    // Handle the click event to assign a name to the selected region
    canvas.addEventListener('click', (event) => {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        regions.forEach((region, index) => {
            if (
                x >= region.x && x <= region.x + region.width &&
                y >= region.y && y <= region.y + region.height
            ) {
                selectedRegion = region;
                selectedRegion.index = index;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                regions.forEach(r => {
                    if (r !== selectedRegion) {
                        ctx.strokeStyle = 'red';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(r.x, r.y, r.width, r.height);
                    }
                });
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.strokeRect(selectedRegion.x, selectedRegion.y, selectedRegion.width, selectedRegion.height);

                const regionName = prompt('Enter a name for this region:');

                const row = regionTable.insertRow();
                row.insertCell(0).textContent = regionName;
                row.insertCell(1).textContent = selectedColor;
                row.insertCell(2).textContent = `${selectedRegion.x}, ${selectedRegion.y}`;
                row.insertCell(3).textContent = `${selectedRegion.width}, ${selectedRegion.height}`;
            }
        });
    });

    // Function to redraw the canvas (e.g., after a region is clicked)
    function redraw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        regions.forEach(r => {
            if (r !== selectedRegion) {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.strokeRect(r.x, r.y, r.width, r.height);
            }
        });
        ctx.strokeStyle = 'blue';
        ctx.lineWidth = 2;
        ctx.strokeRect(selectedRegion.x, selectedRegion.y, selectedRegion.width, selectedRegion.height);
    }

    // Handle color change event
    colorInput.addEventListener('input', (event) => {
        selectedColor = event.target.value;
        if (selectedRegion) {
            selectedRegion.color = selectedColor;
            redraw();
        }
    });
</script>
